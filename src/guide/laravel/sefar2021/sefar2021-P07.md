# Proyecto App Sefar Universal 2021 (Parte VII)
+ Versión: **Laravel Framework 8.31.0**


## Deploy de App Sefar Universal en AWS:
###  Lanzar instancia en EC2:
1. Ir a https://aws.amazon.com/es
2. Ir a **Mi cuenta** > **Consola de administración de AWS** e iniciar sesión.
3. Ir al servicio **EC2** y dar clic en **Instancias New**.
4. Dar clic en el botón de **Lanzar instancia**.
5. Seleccionar:
    + Ubuntu Server 18.04 LTS (HVM), SSD Volume Type - ami-0747bdcabd34c712a (64 bits x86) / ami-08353a25e80beea3e (64 bits Arm)
6. Seleccionar el de tipo t2.2xlarge.
7. Dar clic en el botón **Siguiente: Página Configuración de los detalles de la instancia**.
8. Dejar todo como está y dar clic en el botón **Siguiente: Adición de almacenamiento**.
9. Establecer **Tamaño (GiB)** en **120**.
10. Dar clic en el botón **Siguiente: Agregar etiquetas**.
11. Dejar todo como está y dar clic en el botón **Siguiente: Página Configure Security Group**.
12. Ajustar parámetros:
    + Dejar regla: **SSH**
    + Añadir regla: **HTTP**
    + Añadir regla: **HTTPS**
    + Para la regla **SSH** establecer **Origen** como **Mi IP**
    + Para las reglas **HTTP** y **HTTPS** establecer **Origen** como **Cualquier lugar**
13. Dar clic en el botón **Revisar y lanzar**.
14. Dejar todo como está y dar clic en el botón **Lanzar**.
15. En el cuadro de diálogo para claves seleccionar **Crear un nuevo par de claves**.
	+ Nombre del par de claves: **appsefar**.
	+ Dar clic en el botón: Descargar par de claves
    **Nota**: Guardar en un lugar seguro y evitar que se suba a GitHub, en este caso lo guardaré en la raíz de la carpeta del proyecto, y editaremos el archivo .**gitignore** para evitar que se incluya en los repositorios:
	```
	/node_modules
	/public/hot
	/public/storage
	/storage/*.key
	/vendor
	/a1_soportes
	.env
	.env.backup
	.phpunit.result.cache
	docker-compose.override.yml
	Homestead.json
	Homestead.yaml
	npm-debug.log
	yarn-error.log
	appsefar.pem
	```
16. Dar clic en el botón **Lanzar instancias**.
	**Nota**: Para revisar la nueva instancia se le puede dar clic en el botón **Ver instancias**.
  
### Conectar con la instancia AWS appsefar vía SSH:
1. Para los sistemas operativos Mac o Linux ejecutar:
   + $ chmod 400 appsefar.pem
2. Para el sistema operativo Windows:
   + Ubicar el archivo **appsefar.pem** en disco, presionar sobre el el botón derecho y dar clic en **Propiedades**.
   + Seleccionar la pestaña de **Seguridad**.
   + Presionar el botón: **Opciones avanzadas**.
   + Presionar el botón: **Deshabilitar herencia**.
   + Dar clic: **Quitar todos los permisos heredados de este objeto**.
   + Copiar el nombre del **Propietario** que está entre los paréntesis del usuario (Pedro Bazo).
   + Presionar el botón: **Agregar**.
   + Dar clic: **Seleccionar una entidad de seguridad**.
   + En **Escriba el nombre de objeto para seleccionar** escribrir el nombre copiado en los pasos anteriores.
   + Presionar el botón: **Comprobar nombres**.
   + Presionar el botón: **Aceptar**.
   + Verificar que los permisos que tienen que estar habilitados son:
     - Lectura y ejecución
     - Lectura
   + Presionar el botón: **Aceptar** (Cuadro de diálog: **Entrada de permiso para appsefar.com**).
   + Presionar el botón: **Aceptar** (Cuadro de diálog: **Configuración de seguridad avanzada para appsefar.pem**).
   + Presionar el botón: **Aceptar** (Cuadro de diálog: **Propiedades: appsefar.pem**).
3. En el navegador ingresar a la instancias presionando abajo de **ID de la instancia** y dar clic en el botón **Conectar**.
4. Ir a **Cliente SSH** y copiar el comando de ejemplo: **ssh -i "appsefar.pem" ubuntu@ec2-3-239-101-245.compute-1.amazonaws.com**.
5. En local ejecutar (en la ruta que se encuentre el archivo **appsefar.pem**):
    + $ ssh -i "appsefar.pem" ubuntu@ec2-3-239-101-245.compute-1.amazonaws.com
	+ A la pregunta: Are you sure you want to continue connecting (yes/no/[fingerprint])?
      - Respondemos: yes
    **Nota**: Con esta acción hemos ingresado en el servidor de AWS.

### Configurar nuestro servidor
1. En la terminal del servidor de AWS:
    + Actualizar servidor:
        - $ sudo apt-get update
        - $ sudo apt-get upgrade
        - Cuando pregunte: Do you want to continue? [Y/n]
            * Responder: y
	+ Actualizar nuevamente el servidor:
        - $ sudo apt-get update
    + Configurar entorno para ejecutar Laravel:
        - $ sudo apt-get install software-properties-common
        - $ sudo add-apt-repository ppa:ondrej/php
        - Cuando pregunte: Press [ENTER] to continue or Ctrl-c to cancel adding it.
            * Presionamos ENTER.
        - Actualizar nuevamente el servidor:
            * $ sudo apt-get update
        - Instalar php:
            * $ sudo apt-get install php7.4
            * Cuando pregunte: Do you want to continue? [Y/n]
                * Responder: y
        - Instalar el servidor apache:
            * $ sudo apt-get install apache2
            * $ sudo apt-get install libapache2-mod-php7.4
        	**Nota**: para ver la versión de php:
              * $ php -v
        - Para saber los modulos instalados en php:
            * $ php -m
            * Resultados:
				```
				[PHP Modules]
				calendar
				Core
				ctype
				date
				exif
				FFI
				fileinfo
				filter
				ftp
				gettext
				hash
				iconv
				json
				libxml
				openssl
				pcntl
				pcre
				PDO
				Phar
				posix
				readline
				Reflection
				session
				shmop
				sockets
				sodium
				SPL
				standard
				sysvmsg
				sysvsem
				sysvshm
				tokenizer
				Zend OPcache
				zlib

				[Zend Modules]
				Zend OPcache			
				```
            **Nota**: Constrastar contra https://laravel.com/docs/8.x/deployment#server-requirements y verificar cuales son necesarias.
        - Instalar extensiones de php necesarias para Laravel:
            * $ sudo apt-get install php7.4-bcmath
            * $ sudo apt-get install php7.4-mbstring
                * En: Do you want to continue? [Y/n]
                    Responder: y
            * $ sudo apt-get install php7.4-xml
        - Instalar paquetes que necesitaremos más adelante:
            * $ sudo apt-get install unzip
            * $ sudo apt-get install php7.4-zip
                * En: Do you want to continue? [Y/n]
                    Responder: y
            * $ sudo apt-get install php7.4-mysql
            * $ sudo apt-get install php7.4-curl
2. En el navegador:
    + Ir: **Servicios** > **EC2** > **Recursos** > **Instancias**.
    + Seleccionar nuestra instancia en ejecución.
    + Ubicar: Dirección IPv4 pública: **3.239.101.245**.
    **Nota**: esta será la dirección de nuestro sitio web.
3. En la terminal del servidor de AWS:
    + Reiniciar el servidor apache:
        * $ sudo service apache2 restart
		**Nota**: Para verificar que no tengamos ningún error:
        * $ sudo service apache2 status
    + Habilitar el modulo rewrite
        * $ sudo a2enmod rewrite
    + Reiniciar el servidor apache:
        * $ sudo service apache2 restart
    + Definir punto de acceso a nuestra aplicación web:
        * Ingresar a la ruta: /var/www/html
            - $ cd /var/www/html
            **Nota**: para ver los archivos contenidos en una ruta:
            - $ ls
        * Editar el archivo index.html:
            - $ sudo nano index.html
            - Cambiar la etiqueta title del head por:
				```html
                <title>App Sefar</title>
				```
            - Para guardar, presionar:
                + Ctrl + X
                + y
                + ENTER
        * Editar archivo de configuración de punto de acceso:
            - $ sudo nano /etc/apache2/sites-enabled/000-default.conf
            - Cambiar línea:
				```
             	DocumentRoot /var/www/html
				```
                Por:
				```
            	DocumentRoot /var/www/AppSefarUniversal/public
				```
            - Para guardar, presionar:
                + Ctrl + X
                + y
                + ENTER
    + Reiniciar el servidor apache:
        * $ sudo service apache2 restart

### Instalación de Composer
1. Copiar de la página: https://getcomposer.org/download, el bloque de **Command-line installation**:
	```
	php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
	php -r "if (hash_file('sha384', 'composer-setup.php') === '756890a4488ce9024fc62c56153228907f1545c228516cbf63f885e036d37e9a59d27d63f46af1d4d07ee0f76181c7d3') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); } echo PHP_EOL;"
	php composer-setup.php
	php -r "unlink('composer-setup.php');"
	```
2. En la terminal del servidor de AWS pegar las líneas de comandos que acabamos de copiar y presionar ENTER.
3. Realizar la instalación global de composer:
    + $ sudo mv composer.phar /usr/local/bin/composer
    **Nota 1**: Este comando se encuentra en https://getcomposer.org/doc/00-intro.md
    **Nota 2**: Para comprobar que tenemos instalado composer, ejecutar:
    + $ composer

### Clonar repositorio de GitHUb App Sefar:
1. Ir a la ruta **/var/www**:
    + $ cd /var/www
2. Clonar el repositorio del proyecto:
    + $ sudo git clone https://github.com/petrix12/AppSefarUniversal.git
3. Ir a la ruta **/var/www/AppSefarUniversal**:
    + $ cd /var/www/AppSefarUniversal
4. Para poder instalar las dependencias de **Composer**, ejecutar:
    + $ sudo chown -R ubuntu:www-data .
5. Ejecutar permisos para la carpeta de laravel:
    + $ chmod -R 755 .
    + $ chmod -R 777 ./storage
6. Instalar composer:
    + $ composer install
7. Crear el archivo **.env** a partir de **.env.example**:
    + $ cp .env.example .env
<!-- 8. Generar llave del proyecto:
    + $ php artisan key:generate -->
9. Instalar NodeJs:
    + $ sudo apt install nodejs
        * Do you want to continue? [Y/n]
            Responder: y
10. Para ver la versión de NodeJs:
    + $ nodejs -v
11. Actualizar NodeJs:
    + $ curl -sL https://deb.nodesource.com/setup_14.x | sudo -E bash -
12. Ejecutar:
    + $ sudo apt-get install -y nodejs
	**Nota**: Para ver la versión de npm:
    + $ npm -v
13. Ejecutar:
    + $ npm install
    + $ npm run dev

### Crear base de datos
1. En la página de AWS buscar el servicio **RDS** (https://console.aws.amazon.com/rds/home?region=us-east-1):
    + Dar clic en el botón: **Crear base de datos**.
    + En **Elegir un método de creación de base de datos**:
        * Seleccionar la opción: **Creación estándar**.
    + En **Opciones del motor**:
        * Seleccionar la opción: **MySQL**.
        * Seleccionar la versión: **MySQL 8.0.23**.
    + En **Plantillas**:
        * Seleccionar la opción: **Producción**.
    + En **Configuración** > **Identificador de instancias de bases de datos**:
        * Escribir: appsefar-db
    + En **Configuración** > **Configuración de credenciales** > **Nombre de usuario maestro**:
        * Escribir: appsefar_usr
    + En **Configuración** > **Configuración de credenciales** > **Generación automática de contraseña**: Seleccionar.
    + En **Conectividad** > **Acceso público**: Seleccionar **Si**.
    + En **Configuración adicional** > **Opciones de base de datos** > **Nombre de base de datos inicial**:
        * Escribir: appsefar_db
    + Presionar botón: **Crear base de datos**.
    + Cuando finalice la creación de la base de datos, presionar el botón: **View credential details** y anotar credenciales en un lugar seguro.

### Editar los "Security Group"
1. En la página de AWS seleccionar la base de datos **appsefar-db**: **Amazon RDS** > **Databases**.
2. Seleccionar **Conectividad y seguridad** > **Seguridad** > **Grupos de seguridad de la VPC** > **default (sg-09f6e23a)**.
3. Seleccionar **Grupos de seguridad** > **ID del grupo de seguridad** > **sg-09f6e23a**.
4. Seleccionar **Reglas de entrada** y presionar botón **Edit inbound rules**.
5. Presionar el botón **Agregar regla** y seleccionar el tipo **MySQL/Aurora** y seleccionar como origen **Mi IP**.
6. Presionar botón **Guardar reglas**.

### Conectar base de datos de AWS con local MySQL Workbench
1. En caso de no tener instalado **MySQL Workbench**:
	+ Ir a https://www.mysql.com/products/workbench
	+ Presionar el botón **Download Now »**.
	+ En la siguiente página presionar el botón **Download** y luego en el enlace **No thanks, just start my download**.
	+ Instalar **MySQL Workbench**.
2. En **MySQL Workbench**:
    + Seleccionar **Database** > **Manage Connections...**.
    + En el cuadro de diálogo **Manage Server Connections** suministrar la siguiente información:
        * Presionar botón: New
        * Connection Name: appsefar
        * Hostname: appsefar-db.cgfry9dn7zav.us-east-1.rds.amazonaws.com
        	**Nota**: Es el punto de enlace que aparece en la página de AWS: **RDS** > **Databases** > **appsefar-db**.
        * Port: 3306
        * Username: appsefar_usr
        * Password: ************
    + Presionar botón: **Test Connection** para comprobar el estado de la conección.
    + Presionar botón: **Close**.
    + Seleccionar **Database** > **Connect to Database**.
    + En el cuadro de diálogo **Connect to Database** seleccionamos la conección **appsefar** y presionamos el botón **OK**.
**Nota**: También se puede conectar con la extensión de VSC **MySQL cwejan**.

### Configuración de credenciales en Laravel
1. En la terminal de AWS ir a la ruta **/var/www/AppSefarUniversal**:
    + $ cd /var/www/AppSefarUniversal
2. En la terminal de AWS editar el archivo **.env**:
    + $ nano .env
3. Modificar los siguientes parámetros en el archivo **.env**:
	```
	APP_NAME="App Sefar Universal"
	APP_ENV=production
	APP_KEY=
	APP_DEBUG=false
	APP_URL=http://3.239.101.245

	LOG_LEVEL=debug

	DB_CONNECTION=mysql
	DB_HOST=appsefar-db.cgfry9dn7zav.us-east-1.rds.amazonaws.com
	DB_PORT=3306
	DB_DATABASE=appsefar_db
	DB_USERNAME=appsefar_usr
	DB_PASSWORD=*************

	ONIDEX_CONNECTION=mysql
	ONIDEX_HOST=107.180.2.195
	ONIDEX_PORT=3306
	ONIDEX_DATABASE=onidex
	ONIDEX_USERNAME=pxvim6av41qx
	ONIDEX_PASSWORD=**********

	BROADCAST_DRIVER=log
	CACHE_DRIVER=file
	QUEUE_CONNECTION=sync
	SESSION_DRIVER=database
	SESSION_LIFETIME=120

	MEMCACHED_HOST=127.0.0.1

	REDIS_HOST=127.0.0.1
	REDIS_PASSWORD=null
	REDIS_PORT=6379

	MAIL_DRIVER=smtp
	MAIL_HOST=smtp.gmail.com
	MAIL_PORT=587
	MAIL_USERNAME=info@sefarvzla.com
	MAIL_PASSWORD=**************
	MAIL_ENCRYPTION=tls
	MAIL_FROM_ADDRESS=info@sefarvzla.com
	MAIL_FROM_NAME="${APP_NAME}"

	AWS_ACCESS_KEY_ID=
	AWS_SECRET_ACCESS_KEY=
	AWS_DEFAULT_REGION=eu-west-1
	AWS_BUCKET=

	PUSHER_APP_ID=
	PUSHER_APP_KEY=
	PUSHER_APP_SECRET=
	PUSHER_APP_CLUSTER=mt1

	MIX_PUSHER_APP_KEY="${PUSHER_APP_KEY}"
	MIX_PUSHER_APP_CLUSTER="${PUSHER_APP_CLUSTER}"
	```
	+ **Nota 1**: Luego que se configure el nombre del dominio correspondiente cambiar la variable de entorno:
		```
		APP_URL=http://3.239.101.245
		```
		Por:
		```
		APP_URL=https://app.sefaruniversal.com
		```
	+ **Nota 2**: El valor de la variable de entorno **DB_HOST** proviene de la página de AWS en: **RDS** > **Databases** > **appsefar-db** en **Conectividad y seguridad** -> **Punto de enlace y puerto** -> **Punto de enlace**.
	+ **Nota 3**: Los valores de las variables de entorno correspondiente a **MAIL_** están configurados con la cuenta de **info@sefarvzla.com**, también se podría configurar con una cuenta de **AWS**.
4. Para guardar el archivo **.env**:
    + $ Ctrl + X
    + $ y
    + $ ENTER
5. Generar llave del proyecto:
    + $ php artisan key:generate
6. Para verificar que podemos establecer una conexión con la base de datos, ir a la terminal AWS y ejecutar:
    + $ php artisan tinker
    + />>> DB::connection()->getPdo();
    + **Nota**: si el resultado de la ejecución es parecida a la que se muestra a continuación es que logramos establecer la conexión:
	```json
	=> PDO {#4731
		inTransaction: false,
		attributes: {
		CASE: NATURAL,
		ERRMODE: EXCEPTION,
		AUTOCOMMIT: 1,
		PERSISTENT: false,
		DRIVER_NAME: "mysql",
		SERVER_INFO: "Uptime: 104373  Threads: 6  Questions: 488396  Slow queries: 0  Opens: 337  Flush tables: 3  Open tables: 238  Queries per second avg: 4.679",
		ORACLE_NULLS: NATURAL,
		CLIENT_VERSION: "mysqlnd 7.4.22",
		SERVER_VERSION: "8.0.23",
		STATEMENT_CLASS: [
			"PDOStatement",
		],
		EMULATE_PREPARES: 0,
		CONNECTION_STATUS: "appsefar-db.cgfry9dn7zav.us-east-1.rds.amazonaws.com via TCP/IP",
		DEFAULT_FETCH_MODE: BOTH,
		},
	}	
	```
7. Salir de tinker:
    + />>> Ctrl + C
11. Ejecutar las migraciones en la terminal de AWS:
    + $ php artisan migrate
		+ Do you really wish to run this command? (yes/no) [no]: yes

### Fix: Configuración del servidor
1. Ingresar al archivo de configuración de apache en la terminal de AWS:
    + $ sudo nano /etc/apache2/apache2.conf
	+ $ sudo nano /etc/apache2/sites-available/000-default.conf
2. Comentar las siguientes líneas con #:
	```
	# User ${APACHE_RUN_USER}
	# Group ${APACHE_RUN_GROUP}
	```
3. A continuación agregar las líneas:
	```
	User ubuntu
	Group ubuntu
	```
4. Cambiar el siguiente bloque de códgio:
	```
	<Directory />
			Options FollowSymLinks
			AllowOverride None
			Require all denied
	</Directory>

	<Directory /usr/share>
			AllowOverride None
			Require all granted
	</Directory>

	<Directory /var/www/>
			Options Indexes FollowSymLinks
			AllowOverride None
			Require all granted
	</Directory>
	```
    Por:
	```
	<Directory />
			Options FollowSymLinks
			AllowOverride All
			Require all denied
	</Directory>

	<Directory /usr/share>
			AllowOverride All
			Require all granted
	</Directory>

	<Directory /var/www/>
			Options Indexes FollowSymLinks
			AllowOverride All
			Require all granted
	</Directory>
	```
5. Para guardar los cambios:
    + $ Ctrl + X
    + $ y
    + $ ENTER
6. Habilitar modo rewrite:
    + $ sudo a2enmod rewrite
7. Reiniciar el servidor de apache:
    + $ sudo service apache2 restart
8. Para ver el estatus del servidor apache:
    + $ sudo service apache2 status

### Permitir acceso a base de datos onidex en servidor GoDaddy
1. Ingresar al cPanel de GoDaddy:
	+ https://a2plcpnl0082.prod.iad2.secureserver.net:2083
	+ Introducir las credenciales
2. Dentro del cPanel ir a **BASES DE DATOS** > **MySQL remoto®**.
3. En **Añadir anfitrión de acceso** introducir los siguientes valores:
	+ Anfitrión (se permite el comodín %): **3.239.101.245**
	+ Comment (optional): **AWS appsefar**
4. Presionar el botón **Añadir anfitrión**.

### Configurar FileZilla con nuestra instancia EC2
+ **URL**: https://filezilla-project.org
1. Ejecutar FileZilla e ir a **Edición** > **Opciones...**.
2. En el cuadro de diálogo **Opciones** en **Selecciones página:** ir a **Conexión** > **SFTP**.
3. Luego en el panel de **Claves privadas:** presionar el botón **Añadir archivo de clave...**.
4. Ubicar el archivo de credenciales **appsefar.pem** y presionar el botón **Abrir**.
5. Presionar el botón **Aceptar** para salir del cuadro de diálogo **Opciones**.
6. Ir a **Archivo** > **Gestor de sitios...**.
7. En el cuadro de diálogo **Gestor de sitios** presionar el botón **Nuevo sitio** nombrarlo **AWS App Sefar** e intruducir los siguientes parámetros:
	+ Protocolo: SFTP - SSH File Transfer Protocol
	+ Servidor: 3.239.101.245
	+ Modo de acceso: Interactivo
	+ Usuario: ubuntu
		**Nota 1**: Posibles nombres de usuarios según el sistema operativo en EC-2:
		+ Amazon Linux: ec2-user
		+ RHEL5: root o ec2-user.
		+ Ubuntu: ubuntu
		+ SUSE Linux: root . Para 
		+ Debian: admin. 
		+ Otros: consulte el proveedor de AMI.
		**Nota 2**: FileZilla determinará automáticamente la clave. No se necesitará especificarla después de haberla importardo.
8. Presionar el botón **Conectar**.

### Ejemplo de registro de un cliente con parámetros GET
   + http://3.239.101.245/register?nombre=Detal%20y%20Borrar&cnacimiento=Punto%20Fijo&email=delete.borrar33%40gmail.com&fnacimiento=1977-11-03&nombre_f=Perensejo%20Borrar&nombres=Fulanito&pasaporte=1234567999&pasaporte_f=5555555&pnacimiento=Venezuela&sexo=M

### Actualizar proyecto en AWS desde GitHub
+ $ ssh -i "appsefar.pem" ubuntu@ec2-3-239-101-245.compute-1.amazonaws.com
+ $ cd /var/www/AppSefarUniversal
+ $ sudo git pull
	**Nota**: en caso de necesitar forzar la actualización:
	+ $ sudo git reset --hard HEAD
	+ $ git pull
  
### Puntos finales para finalizar la migración de GoDaddy a AWS
1. Migrar todos los registros de todas las tablas de GoDaddy a la instacia de MySQL de AWS.
3. Copiar archivos de la ruta **storage\app\public** de **GoDaddy** a **AWS**.
4. Copiar documentos.
5. Transferir nombre de dominio de GoDaddy a AWS.
6. Estudiar como guardar los documentos directamente en Google Drive.


## Configurar AWS S3
1. Ingresar en: https://aws.amazon.com/es
2. Ir a **IAM** (Administrar el acceso a los recursos de AWS): https://us-east-1.console.aws.amazon.com/iamv2/home?region=us-east-1#/home
3. Crear usuario:
    + Clic en **Usuarios** y luego en **Agregar usuarios**.
    + Nombre de usuario: **appsefar**.
    + Tipo de credenciales: **Clave de acceso: acceso mediante programación**.
    + Clic en **Siguiente: Permisos**.
    + Clic en **Asociar directamente las políticas existentes**.
    + Seleccionar el permiso:
        + AmazonS3FullAccess
    + Clic en **Siguiente: Etiquetas**.
    + Clic en **Siguiente: Revisar**.
    + Clic en **Crear un usuario**.
    + Obtener los valores:
        + **ID de clave de acceso**.
        + **Clave de acceso secreta**.
5. Crear Bucket:
    + Ir a **S3** (Almacenamiento escalable en la nube): https://s3.console.aws.amazon.com/s3/get-started?region=us-east-1
    + Clic en **Crear bucket**:
        + Nombre del bucket: **appsefar-bucket-s3**.
        + Región de AWS: **EE. UU. Est (Norte de Virginia) us-east-1**.
        + Clic en **Crear bucket**.
    + Clic en el nuevo bucket: **appsefar-bucket-s3**.
    + Clic en **Permisos**:
        + En **Propiedad de objetos** clic en **Editar**.
        + Seleccionar **ACL habilitados**.
        + En **Habilitar las ACL desactiva la configuración forzada del propietario del bucket en cuanto a la propiedad del objeto** seleccionar **Reconozco que las ACL se restaurarán.**
        + Clic en **Guardar cambios**.
    + Clic en **Permisos**:
        + En **Bloquear acceso público (configuración del bucket)** clic en **Editar**:
            + Deseleccionar **Bloquear todo el acceso público**.
            + Seleccionar: 
                + Bloquear el acceso público a buckets y objetos concedido a través de políticas de bucket y puntos de acceso públicas nuevas
                + Bloquear el acceso público y entre cuentas a buckets y objetos concedido a través de cualquier política de bucket y puntos de acceso pública
        + Clic en **Guardar cambios** y confirmar.
    + **Opcional**: En caso de querer establecer políticas de almacenamiento:
        + Clic en **Permisos**:
            + En **Política de bucket** clic en **Editar**.
            + Política:
                + Obtener **ARN del bucket**: arn:aws:s3:::appsefar-bucket-s3
                ```json
                {  
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Statement1",
                            "Principal": "*",
                            "Effect": "Allow",
                            "Action": [
                                "s3:DeleteObject",
                                "s3:GetObject",
                                "s3:PutObject"
                            ],
                            "Resource": ["arn:aws:s3:::appsefar-bucket-s3/*"]   // ARN del bucket concatenado con "/*"
                        }
                    ]
                }
                ```
6. Dar valores a variables de entorno Laravel en **.env**:
    ```
    ≡
    AWS_ACCESS_KEY_ID=[ID de clave de acceso]
    AWS_SECRET_ACCESS_KEY=[Clave de acceso secreta]
    AWS_DEFAULT_REGION=us-east-1
    AWS_BUCKET=[Nombre del bucket]
    ≡
    ```
7. Instalar dependencia para Amazon S3:
    + $ composer require --with-all-dependencies league/flysystem-aws-s3-v3 "1.0.29"
    + $ composer require league/flysystem-cached-adapter "~1.0"
    + **Documentación**: https://laravel.com/docs/8.x/filesystem#the-public-disk
8. Limpiar configuración Laravel:
    + $ php artisan optimize
    + $ php artisan cache:clear


## Comandos Git para crear rama y luego hacer merge en la principal
1. Realizar commit antes de empezar:
    + $ git add .
    + $ git commit -am "Estado del repositorio actual"
    + $ git push -u origin master
2. Crear rama y cambiar a ella:
    + $ git checkout -b nombre-rama
3. Confirmar los cambios en la nueva rama:
    + $ git add .
    + $ git commit -am "Confirmando los cambios"
4. Volver a la rama principal y unir los cambios:
    + $ git checkout master
    + $ git rebase nombre-rama


## Configuración del archivo **.htaccess**:
+ Configuración 1:
    ```
    # DON NOT REMOVE THIS LINE AND TEN LINES BELLOW SSL_REDIRECT:corporacioncabv.com/appsefar
    RewriteEngine on
    RewriteCond %{HTTPS} off
    RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    SetEnv ENVIRONMENT production

    RewriteRule ^(.*)$ public/$1 [L]

    # DON NOT REMOVE THIS LINE AND TEN LINES BELLOW SSL_REDIRECT:corporacioncabv.com/appsefar
    ```
+ Configuración 2:
    ```
    <IfModule mod_rewrite.c>
        RewriteEngine on
        RewriteCond %{REQUEST_URI} !^public
        RewriteRule ^(.*)$ public/$1 [L]
    </IfModule>
    ```

## Módulo cursos
+ Entidades:
    + **users** (usuarios):
        + id
        + name
        + email
        + password
    + **profiles** (profesores):
        + id
        + title
        + biography
        + website
        + socialnetwork_name
        + socialnetwork_url
    + **courses** (cursos):
        + id
        + title
        + subtitle
        + description
        + status
    + **reviews** (calificaciones):
        + id
        + comment
        + rating
    + **levels** (niveles):
        + id
        + name
    + **categories** (categorías):
        + id
        + name
    + **prices** (precios):
        + id
        + name
        + value
    + **goals** (metas):
        + id
        + name
    + **requirements** (requerimientos):
        + id
        + name
    + **audiences**:
        + id
        + name
    + **sections**:
        + id
        + name
    + **lessons**:
        + id
        + name
        + url
    + **platforms** (plataformas):
        + id
        + name
    + **descriptions** (descripciones):
        + id
        + name
+ Tablas polimorficas:
    + **resources** (recursos):
        + id
        + url
        + resourceable_id
        + resourceable_type
    + **comments** (comentarios):
        + id
        + name
        + commentable_id
        + commentable_type
    + **likes** (me gustan):
        + id
        + value (0 o 1)
        + likeable_id
        + likeable_type
    + **images** (imagenes):
        + id
        + url
        + imageable_id
        + imageable_type
+ Tablas intermedias (auxiliares):
    + course_user
    + lesson_user
+ Relaciones:
    + **1:1**:
        + profiles - users
        + descriptions - lessons
    + **1:n**:
        + users - courses
        + users - reviews
        + courses - reviews
        + levels - courses
        + categories - courses
        + prices - courses
        + courses - goals
        + courses - requirements
        + courses - audiences
        + courses - sections
        + sections - lessons
        + platforms - lessons
        + users - course_user
        + courses - course_user
        + lessons -lesson_user
        + users - lesson_user
    + **n:m**:
        + courses - users
        + lessons - users


## Modificación Registro de clientes (DIC 2022)
+ Esbozo: https://www.figma.com/file/OKMIhE6fyw4jEPLHCJCq5i/Untitled?node-id=0%3A1&t=3ZidiJFV8gPENYZ8-0
::: tip Para pruebas en local
+ Iniciar servidor de base de datos con **XAMPP** o **Laragon**.
+ Iniciar servidor web con: **php artisan serve --port=8050**
:::
1. Creas (e ir) rama **registro_v2**:
	+ $ git checkout -b registro_v2
	::: warning Advertencia
	Antes crear un commit:
	+ git add .
	+ git commit -m "Antes de modificar Registro de clientes (DIC 2022)"
	+ git push
	<p></p>
	:::
2. Instalar dependencia composer:
	+ $ composer require stripe/stripe-php
3. Modificar archivo de prueba (resources\views\pruebas\registro.blade.php) para el traspaso de cliente de **JotForm** a **app.sefaruniversal.com**:
	```php
	≡
    <form action="{{ route('test.capturar_parametros_get') }}" method ="GET">
        <div class="shadow overflow-hidden sm:rounded-md">
            <div class="container">
                <p class="my-2 ml-2 text-bold text-blue-600">Datos Clientes:</p>
                <div class="md:flex ms:flex-wrap">
                    {{-- Ejemplo de URL a generar --}}
                    {{-- https://app.universalsefar.com/register?apellidos=XXXX&nombres=XXXX&email=XXXX&dni=XXXX&servicio=XXXX --}}
                    <div class="px-1 py-2 m-2 flex-1">    {{-- firstname --}}
                        <div>
                            <label for="firstname" class="block text-sm font-medium text-gray-700">Nombres</label>
                            <input value="Fulanito" type="text" name="firstname" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        </div>
                    </div>

                    <div class="px-1 py-2 m-2 flex-1">    {{-- lastname --}}
                        <div>
                            <label for="lastname" class="block text-sm font-medium text-gray-700">Apellidos</label>
                            <input value="Detal y Borrar" type="text" name="lastname" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        </div>
                    </div>

                    <div class="px-1 py-2 m-2 flex-1">    {{-- email --}}
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">e-mail</label>
                            <input value="delete.borrar@gmail.com" type="email" name="email" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        </div>
                    </div>

                    <div class="px-1 py-2 m-2 flex-1">    {{-- phone --}}
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700">Teléfono</label>
                            <input value="+584141249753" type="text" name="phone" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        </div>
                    </div>
                </div>
                <div class="md:flex ms:flex-wrap">
                    <div class="px-1 py-2 m-2 flex-1">    {{-- numero_de_pasaporte --}}
                        <div>
                            <label for="numero_de_pasaporte" class="block text-sm font-medium text-gray-700">DNI</label>
                            <input value="BORRAR123" type="text" name="numero_de_pasaporte" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        </div>
                    </div>

                    <div class="px-1 py-2 m-2 flex-1">    {{-- nacionalidad_solicitada --}}
                        <div>
                            <label for="nacionalidad_solicitada" class="block text-sm font-medium text-gray-700">Servicio</label>
                            <input value="Española LMD" type="text" name="nacionalidad_solicitada" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        </div>
                    </div>

                    <div class="px-1 py-2 m-2 flex-1">    {{-- n000__referido_por__clonado_ --}}
                        <div>
                            <label for="n000__referido_por__clonado_" class="block text-sm font-medium text-gray-700">Referido por</label>
                            <input value="Yeinson Diaz" type="text" name="n000__referido_por__clonado_" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        </div>
                    </div>

                    <div class="px-1 py-2 m-2 flex-1">    {{-- aplicar_cupon --}}
                        <div>
                            <label for="aplicar_cupon" class="block text-sm font-medium text-gray-700">Cupón</label>
                            <input value="55677" type="text" name="aplicar_cupon" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        </div>
                    </div>
                </div>
                <div class="md:flex ms:flex-wrap">
                    <div class="px-1 py-2 m-2 flex-1">    {{-- numero_de_pasaporte --}}
                        <div>
                            <label for="pais_de_nacimiento" class="block text-sm font-medium text-gray-700">País de nacimiento</label>
                            <input value="Venezuela" type="text" name="pais_de_nacimiento" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        </div>
                    </div>
                </div>
            </div>
            <div class="px-4 py-3 bg-gray-50 text-right sm:px-6">
                <button type="submit" class="cfrSefar inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Generar URL
                </button>
            </div>
        </div>
    </form>
	≡
	```
4. Modificar controlador **app\Http\Controllers\GetController.php**:
	```php
	≡
    public function capturar_parametros_get(Request $request){
        $pos = strpos($request->fullUrl(), '?');
        $parametros = substr($request->fullUrl(), $pos);
        Alert::info('Enlaces para registrar cliente', '
            <small>
                <p><strong>http://sefar.test/register</strong>'.$parametros.'</p>
                <br><hr><br>
                <p><strong>https://app.sefaruniversal.com/register</strong>'.$parametros.'</p>
                <br><hr><br>
                <p><strong>http://127.0.0.1:8080/register</strong>'.$parametros.'</p>
            </small>'
        )->toHtml()->persistent(true);
        return back();
    }
	≡	
	```
5. Modificar vista **resources\views\auth\register.blade.php**:
	```php
	***
	```
6. Tanto en la aplicación local como en producción crear permisos **pay.services** y **finish.register**.
	::: tip Nota
	+ Ruta para crear permiso: **URL-LOCAL-O-PRODUCCIÓN/permissions/create**
	:::
7. Agregar campos **phone**, **servicio**, **pay** en la migración **database\migrations\2014_10_12_000000_create_users_table.php**:
	```php{13-14}
	≡
	Schema::create('users', function (Blueprint $table) {
		$table->id();
		$table->string('name');
		$table->string('email',175)->unique();

		$table->string('passport',175)->nullable()->unique();
		$table->integer('user_id')->nullable();
		$table->string('social_id')->nullable();
		$table->string('picture')->nullable();
		$table->dateTime('created')->nullable();
		$table->string('password_md5')->nullable();

		$table->string('phone')->nullable();
		$table->string('servicio')->nullable();
		$table->integer('pay')->nullable();

		$table->dateTime('date_of_birth')->nullable();
		$table->string('nombres')->nullable();
		$table->string('apellidos')->nullable();
		$table->string('genero')->nullable();
		$table->string('pais_de_nacimiento')->nullable();
		$table->string('ciudad_de_nacimiento')->nullable();
		$table->string('referido_por')->nullable();

		$table->timestamp('email_verified_at')->nullable();
		$table->string('password');
		$table->rememberToken();
		$table->foreignId('current_team_id')->nullable();
		$table->text('profile_photo_path')->nullable();
		$table->timestamps();
	});
	≡
	```
8. Agregar los campos **phone**, **servicio**, **date_of_birth**, **nombres**, **apellidos**, **genero**, **pais_de_nacimiento**, **ciudad_de_nacimiento** y **referido_por** en la asignación masiva del modelo **app\Models\User.php**:
	```php{9-10}
	≡
    protected $fillable = [
        'name',
        'email',
        'password',
        'password_md5',
        'passport',
        'email_verified_at',
        'phone',
        'servicio',
		'pay',
		'date_of_birth',
		'nombres',
		'apellidos',
		'genero',
		'pais_de_nacimiento',
		'ciudad_de_nacimiento',
		'referido_por'
	```
10. Agregar los campos **phone**, **servicio**, **date_of_birth**, **nombres**, **apellidos**, **genero**, **pais_de_nacimiento**, **ciudad_de_nacimiento** y **referido_por** en la tabla **users** en la base de datos local y la de producción:
	```
	Nombre					Tipo		Longitud/Valores 	Predeterminado
	phone					VARCHAR		32					NULL
	servicio				VARCHAR		32					NULL
	pay						INT								NULL
	date_of_birth			DATETIME						NULL
	nombres					VARCHAR		100					NULL
	apellidos				VARCHAR		100					NULL
	genero					VARCHAR		10					NULL
	pais_de_nacimiento		VARCHAR		100					NULL
	ciudad_de_nacimiento	VARCHAR		100					NULL
	referido_por			VARCHAR		100					NULL
	```		
9. Modificar método create del controlador **app\Actions\Fortify\CreateNewUser.php**:
	```php
	≡
    public function create(array $input)
    {
        // Verificar que el número de pasoporte no exista
        $rol = $input['rol'];
        $passport = $input['passport'];

        if($rol == 'cliente'){
            $user = User::where('passport','LIKE',$passport)->get();
            if(empty($user[0]->passport)){
                // Verificar si el usuario esta registrado en agclientes
                $agcliente_v = Agcliente::where('IDCliente',trim($passport))->where('IDPersona',1)->count();
                if($agcliente_v == 0){
                    // Incluir al cliente en la tabla agclientes
                    Agcliente::create([
                        'IDCliente' => trim($input['passport']),
                        'IDPersona' => 1,
                        'Nombres' => trim($input['nombres']),
                        'Apellidos' => trim($input['apellidos']),
                        'NPasaporte' => trim($input['passport']),
                        'PNacimiento' => trim($input['pais_de_nacimiento']),
                        'PaisNac' => trim($input['pais_de_nacimiento']),
                        'referido' => trim($input['referido']),
                        'FRegistro' => date('Y-m-d H:i:s'),
                        'FUpdate' => date('Y-m-d H:i:s'),
                        'Usuario' => trim($input['email']),
                    ]);
                }
            }
            Validator::make($input, [
                'name' => ['required', 'string', 'max:255'],
                'email' => ['required', 'string', 'email', 'max:255', 'unique:users'],
                'passport' => ['required','unique:users', 'min:5', 'max:170'],
                'password' => $this->passwordRules(),
                'terms' => Jetstream::hasTermsAndPrivacyPolicyFeature() ? ['required', 'accepted'] : '',
            ])->validate();
        }else{
            Validator::make($input, [
                'name' => ['required', 'string', 'max:255'],
                'email' => ['required', 'string', 'email', 'max:255', 'unique:users'],
                'password' => $this->passwordRules(),
                'terms' => Jetstream::hasTermsAndPrivacyPolicyFeature() ? ['required', 'accepted'] : '',
            ])->validate();
        }
        $user = User::create([
            'name' => $input['name'],
            'email' => $input['email'],
            'password' => Hash::make($input['password']),
            'passport' => $input['passport'],
            'email_verified_at' => date('Y-m-d H:i:s'),
            'phone' => $input['phone'],
            'servicio' => $input['servicio'],
            'pay' => 0,
            'nombres' => $input['nombres'],
            'apellidos' => $input['apellidos'],
            'pais_de_nacimiento' => $input['pais_de_nacimiento'],
            'referido_por' => $input['referido'],
        ]);
        if($rol == 'cliente'){
            //$user->email_verified_at = date('Y-m-d H:i:s');
            //Artisan::call('view:clear');
            // Enviar un correo al cliente indicando que se ha registrado con exito
            $mail_cliente = new RegistroCliente($user);
            Mail::to($user->email)->send($mail_cliente);
            // Enviar un correo al equipo se Sefar indicando que se ha registrado un cliente
            $mail_sefar = new RegistroSefar($user);
            Mail::to([
                'pedro.bazo@sefarvzla.com',
                'gerenciait@sefarvzla.com',
                /* 'egonzalez@sefarvzla.com', */
                'analisisgenealogico@sefarvzla.com',
                'asistentedeproduccion@sefarvzla.com',
                /* 'arosales@sefarvzla.com', */
                /* 'czanella@sefarvzla.com', */
                'organizacionrrhh@sefarvzla.com',
                'gcuriel@sefarvzla.com'
            ])->send($mail_sefar);

            return $user->assignRole('Cliente')->givePermissionTo(['pay.services', 'finish.register']);
        }else{
            return $user;
        }
    }
	≡
	```
11. Modificar vista **resources\views\mail\registro-cliente.blade.php**:
	```php
	≡
	<table class="inner-body" align="center" width="570" cellpadding="0" cellspacing="0" role="presentation" style="box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; position: relative; -premailer-cellpadding: 0; -premailer-cellspacing: 0; -premailer-width: 570px; background-color: #ffffff; border-color: #e8e5ef; border-radius: 2px; border-width: 1px; box-shadow: 0 2px 0 rgba(0, 0, 150, 0.025), 2px 4px 0 rgba(0, 0, 150, 0.015); margin: 0 auto; padding: 0; width: 570px;">
		<!-- Body content -->
		<tr>
			<td class="content-cell" style="box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; position: relative; max-width: 100vw; padding: 32px;">
				<h1 style="box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; position: relative; color: #3d4852; font-size: 18px; font-weight: bold; margin-top: 0; text-align: left;">
					¡Bienvenido a Sefar Universal!
				</h1>
				<p style="box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; position: relative; font-size: 16px; line-height: 1.5em; margin-top: 0; text-align: left;">
					Estimado(a) <strong>{{ $user->name }}</strong> hemos recibido el inicio de su proceso.
				</p>
				<p style="box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; position: relative; font-size: 16px; line-height: 1.5em; margin-top: 0; text-align: left;">
					En estos momentos su información será remitida al departamento de genealogía e historia para el respectivo análisis de su árbol genealógico.
				</p>
				<p style="box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; position: relative; font-size: 16px; line-height: 1.5em; margin-top: 0; text-align: left;">
					Si no ha podido cargar los datos de su árbol, puede hacerlo entrando a nuestra plataforma en este momento o cuando lo desee, mediante el siguiente enlace:
					<a href="https://app.universalsefar.com/login">https://app.universalsefar.com/login</a>
					con su correo {{ $user->email }}, y cuando finalice presione en <strong>finalizar carga</strong>.
				</p>
				<p style="box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; position: relative; font-size: 16px; line-height: 1.5em; margin-top: 0; text-align: left;">
					Mientras más datos proporciones más fácil y rápido será la realización de tu estudio genealógico.
				</p>
				<p style="box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; position: relative; font-size: 16px; line-height: 1.5em; margin-top: 0; text-align: left;">
					Una vez tengamos respuesta sobre el análisis de sus datos le comunicaremos.
				</p>
				<p style="box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; position: relative; font-size: 16px; line-height: 1.5em; margin-top: 0; text-align: left;">
					En caso de requerir alguna información adicional relacionada con este asunto
					o cualquier otro relacionado con el proceso, por favor no dude en comunicarse con nosotros por el
					correo electrónico <strong><a href="mailto:info@sefaruniversal.com">info@sefaruniversal.com</a></strong> y/o por los siguientes números de teléfono de atención al cliente:
					<br>
					<ul>
						<li>USA: <a href="tel:+16032621727">+1 603 2621727</a></li>
						<li>España: <a href="tel:+34911980993">+34 911 980993</a></li>
						<li>Venezuela: <a href="tel:+582127201170">+58 212 7201170</a></li>
						<li>Colombia: <a href="tel:+570353195843">+57 035 3195843</a></li>
					</ul>
				</p>
				<p style="box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; position: relative; font-size: 16px; line-height: 1.5em; margin-top: 0; text-align: left;">
					Atención de lunes a sábado las 24hrs.
				</p>
				<p style="box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; position: relative; font-size: 16px; line-height: 1.5em; margin-top: 0; text-align: left;">
					Huso horario Colombia (GMT-5).
				</p>
				<br>
				<p style="box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; position: relative; font-size: 16px; line-height: 1.5em; margin-top: 0; text-align: left;">
					Atentamente,
					<br>
					Departamento de Atención al Cliente.
					<br>
					<img src="https://raw.githubusercontent.com/petrix12/imagenes2022/main/Sefar/unnamed.png" alt="Logo Sefar" height="60">
				</p>
			</td>
		</tr>
	</table>
	≡
	```
12. Modificar archivo de rutas **routes\web.php**:
	```php
	≡
	***
	```
13. Modificar controlador **app\Http\Controllers\Controller.php** para administrar la vista de clientes:
	```php{6-16}
	≡
	if(Auth::user()->hasRole('MG-Tours')){
		return view('crud.agclientes.index');
	}

	// Clientes corrientes
	if (Auth::user()->hasRole("Cliente")){
		if(Auth::user()->pay==0){
			return redirect()->route('clientes.pay');
		} else if (Auth::user()->pay==1){
			return redirect()->route('clientes.getinfo');
		} else {
			$IDCliente = Auth::user()->passport;
			return view('arboles.tree', compact('IDCliente'));
		}
	}

	$countries = Country::where('pais','!=','aanull')
					->orderBy('pais','ASC')->get();	
	≡
	```
14. Configurar **config\adminlte.php** para el menú de los clientes:
	```php
	≡
	/* *** CLIENTES *** */
	[
		'text'        => 'Menú de opciones',
		'icon'        => 'fas fa-caret-square-down',
		'icon_color'  => 'blue',
		'can'  => 'cliente',
		'submenu' => [
			[
				'text'          => 'Pago del análisis',
				'icon'          => 'fas fa-money-bill',
				'icon_color'    => 'yellow',
				'route'         => 'clientes.pay',
				'can'           => 'pay.services',
			],
			[
				'text'          => 'Completar información',
				'icon'          => 'fas fa-user-plus',
				'icon_color'    => 'yellow',
				'route'         => 'clientes.getinfo',
				'can'           => 'cliente',
			],
			[
				'text'          => 'Cargar árbol',
				'icon'          => 'fas fa-sitemap',
				'icon_color'    => 'yellow',
				'route'         => 'clientes.tree',
				'can'           => 'cliente',
			],
			[
				'text'          => 'Perfil de usuario',
				'icon'          => 'fas fa-user-cog',
				'icon_color'    => 'yellow',
				'url'           => 'user/profile',
				'can'           => 'cliente',
			],
		],
	],
	[
		'text'          => 'Finalizar carga',
		'icon'          => 'fas fa-sign-out-alt',
		'icon_color'    => 'blue',
		'route'         => 'clientes.salir',
		'can'           => 'cliente',
	],
	≡
	```
15. Agregar código de seguimiento en **resources\views\layouts\app.blade.php**:
    ```php{4-11,16-18}
	<!DOCTYPE html>
	<html lang="{{ str_replace('_', '-', app()->getLocale()) }}">
		<head>
			<!-- Google tag (gtag.js) -->
			<script async src="https://www.googletagmanager.com/gtag/js?id=UA-189067277-1"></script>
			<script>
				window.dataLayer = window.dataLayer || [];
				function gtag(){dataLayer.push(arguments);}
				gtag('js', new Date());
				gtag('config', 'UA-189067277-1');
			</script>
			≡
		</head>
		<body class="font-sans antialiased">
			≡
			<!-- Start of HubSpot Embed Code -->
			<script type="text/javascript" id="hs-script-loader" async defer src="//js.hs-scripts.com/20053496.js"></script>
			<!-- End of HubSpot Embed Code -->
		</body>
	</html>
	```
16. Modificar plantilla **resources\views\navigation-menu.blade.php**:
	```php{8}
	<nav x-data="{ open: false }" class="bg-white border-b border-gray-100">
		<!-- Primary Navigation Menu -->
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
			<div class="flex justify-between h-16">
				<div class="flex">
					<div class="hidden space-x-8 sm:-my-px sm:ml-10 sm:flex">
						<div class="block px-2 py-3 text-lg ctvSefar">
							<strong>{{ (Auth::user()->servicio != null) ? 'Servicio: ' . Auth::user()->servicio : Auth::user()->name }}</strong>
						</div>
					</div>
				</div>
				≡
			</div>
		</div>
		≡
	</nav>
	```
17. Crear vista **resources\views\clientes\getinfo.blade.php**:
	```php
	```
18. Crear vista **resources\views\clientes\pay.blade.php**:
	```php
	```
19. Modificar controlador **app\Http\Controllers\ClienteController.php** para añadir los métodos **getinfo** y **pay** .........:
	```php
	```
20. Modificar vista **resources\views\livewire\crud\users-table.blade.php**:
	```php
	≡
	<table class="min-w-full divide-y divide-gray-200">
		<thead class="bg-gray-50">
			<tr>
				<th scope="col" class="px-3 py-2 text-left text-md font-medium text-gray-500 uppercase tracking-wider">
					{{-- - ■ ■ - --}}
					- <i class="fas fa-portrait"></i> -
				</th>{{--
				<th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
					ID
				</th> --}}
				<th scope="col" class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
					{{ __('User name') }}
				</th>{{--
				<th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
					{{ __('Passport') }}
				</th> --}}
				<th scope="col" class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
					{{ __('Correo electrónico') }}
				</th>
				<th scope="col" class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
					{{ __('Servicio') }}
				</th>
				<th scope="col" class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
					{{ __('Fecha de registro') }}
				</th>
				{{-- @can('crud.permissions.edit')
				<th scope="col" class="px-1 y-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
					{{ __('Permissions') }}
				</th>
				@endcan --}}
				@can('crud.users.edit')
				<th scope="col" class="px-1 y-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
					{{ __('Edit') }}
				</th>
				@endcan
				@can('crud.users.destroy')
				<th scope="col" class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
					{{ __('Remove') }}
				</th>
				@endcan
			</tr>
		</thead>
		<tbody class="bg-white divide-y divide-gray-200">
		@foreach ($users as $user)
			<tr>
				<td class="px-3 py-2 whitespace-nowrap text-center">
					<div class="flex-shrink-0 h-10 w-10">
						<img
							class="h-10 w-10 rounded-full"
							src="{{ $user->profile_photo_url }}"
							onerror="this.src='{{ Storage::disk('s3')->url('imagenes/auxiliar/user.png') }}'"
							alt="Foto usuario"
						>
					</div>
				</td>
				<td class="px-2 py-2 whitespace-nowrap">
					<small>{{ Str::limit($user->name, 20) }}</small>
				</td>
				<td class="px-2 py-2 whitespace-nowrap">
					<small>{{ $user->email }}</small>
				</td>
				<td class="px-2 py-2 whitespace-nowrap">
					<small>{{ $user->servicio }}</small>
				</td>
				<td class="px-2 py-2 whitespace-nowrap">
					<small>{{ date_format($user->created_at,"Y-m-d") }}</small>
				</td>
				@can('crud.users.edit')
				<td class="px-1 py-2 whitespace-nowrap text-center font-medium">
					<a href="{{ route('crud.users.edit', $user) }}" class="mx-12 text-grey-600 hover:text-indigo-900" title="Editar"><i class="fas fa-edit"></i></a>
				</td>
				@endcan
				@can('crud.users.destroy')
				<td class="px-3 py-2 whitespace-nowrap text-center font-medium">
					<form action="{{ route('crud.users.destroy', $user) }}" method="POST">
						@csrf
						@method('delete')
						<button
							type="submit"
							class="text-red-600 hover:text-red-900"
							title="eliminar usuario"
							onclick="return confirm('¿Está seguro que desea eliminar a este usuario?')"><i class="fas fa-trash"></i>
						</button>
					</form>
				</td>
				@endcan
			</tr>
		@endforeach
		</tbody>
	</table>
	≡	
	```
21. mmmm








22. Realizar commit:
	+ $ git checkout master
	+ $ git merge registro_v2
	+ $ git push origin master

$user->revokePermissionTo('pay.services');



complete su pago
https://buy.stripe.com/14k5mB2qt9Cp68U7ss


## Deploy en Hostinger
1. Ingresar a [Hostinger](https://www.hostinger.es).
2. Crear subdominio **app.sefaruniversal.com**.
3. Acceder mediante SSH.
4. Si existe, eliminar carpeta **public_html/app**.
5. En la raíz de **public_html** ejecutar:
	+ $ git clone https://github.com/petrix12/AppSefarUniversal.git
	+ Cambiar el nombre de la carpeta del repositorio **AppSefarUniversal** por **app**.
6. En la raíz de **app**, ejeuctar:
	+ $ composer install
7. Migrar base de datos **sefar** de GoDaddy a Hostinger.
	::: warning Advertencia
	Ahora la base de datos en Hostinger se llama **u530524868_sefar**.
	:::
9. Copiar el archivo **.env** de GoDaddy a Hostinger y cambiar las variables de entorno correspondientes a base de datos y correos.
10. Crear **.htaccess** en el hosting:
	```htaccess
	RewriteEngine on
	RewriteCond %{REQUEST_URI} !^public
	RewriteRule ^(.*)$ public/$1 [L]
	```
11. Modificar **.gitignore**:
	```gitignore
	≡
	.htaccess
	```
12. mmm

